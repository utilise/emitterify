function promise(){var n,e,t=new Promise(function(t,r){n=t,e=r});return arguments.length&&n(arguments[0]),t.resolve=n,t.reject=e,t}function def(n,e,t,r){return n.host&&n.host.nodeName&&(n=n.host),e.name&&(t=e,e=e.name),!(e in n)&&Object.defineProperty(n,e,{value:t,writable:r}),n[e]}module.exports=function(n){function e(e,r,o){for(var i=n.on[e.split(".")[0]]||[],u=0;u<i.length;u++)i[u].ns&&o&&!o(i[u].ns)||t(i[u].once?i.splice(u--,1)[0]:i[u],r);for(var u=0;u<n.on["*"].length;u++)t(n.on["*"][u],[e,r]);return n}function t(e,t){e.next?e.next(t):t instanceof Array?e.apply(n,t):e.call(n,t)}function r(e,t,r){function o(e){return e.once=r,s&&(n.on[u][e.ns=s]=e),c.push(e),e.next?e:n}var u=e.split(".")[0],s=e.split(".")[1],c=n.on[u]=n.on[u]||[];return!t&&s?(t=n.on[u][s])?t:o(f()):t||s?t&&s?o((i(c,n.on[u][s]),t)):!(!t||s)&&o(t):o(f())}function o(e,t){return n.on(e,t,!0)}function i(n,e){for(var t=n.length;~--t&&(e==n[t]||e==n[t].fn||!e);)n.splice(t,1)}function u(e,t){i(n.on[e]||[],t),t&&t.ns&&delete li[t.ns]}function f(n,e){var t=promise();return t.listeners=[],t.parent=n,t.fn=e,t.i=0,t.map=function(n){var e=f(t,n);return t.listeners[t.listeners.push(function(t,r){e.next(n(t,r,e))})-1].fn=n,e},t.filter=function(n){var e=f(t,n);return t.listeners[t.listeners.push(function(t,r){n(t,r,e)&&e.next(t)})-1].fn=n,e},t.reduce=function(n,e){var r=f(t,n);return t.listeners[t.listeners.push(function(t,o){r.next(e=n(e,t,o,r))})-1].fn=n,r},t.next=function(n){return t.resolve(n),t.listeners.map(function(e){e(n,t.i)}),t.i++,t},t.off=function(n){return i(t.listeners,n),t},t.unsubscribe=function(){return t.parent.off(t.fn),t.parent=null,t},t}return n=n||{},def(n,"emit",e,1),def(n,"once",o,1),def(n,"off",u,1),def(n,"on",r,1),n.on["*"]=[],n};