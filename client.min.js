function promise(){var n,e,t=new Promise(function(t,r){n=t,e=r});return arguments.length&&n(arguments[0]),t.resolve=n,t.reject=e,t}function def(n,e,t,r){return n.host&&n.host.nodeName&&(n=n.host),e.name&&(t=e,e=e.name),!(e in n)&&Object.defineProperty(n,e,{value:t,writable:r}),n[e]}module.exports=function(n){function e(e,r,s){for(var o=n.on[e.split(".")[0]]||[],i=0;i<o.length;i++)o[i].ns&&s&&!s(o[i].ns)||t(o[i].once?o.splice(i,1)[0]:o[i],r);for(var i=0;i<n.on["*"].length;i++)t(n.on["*"][i],[e,r]);return o.source&&t(o.source,r),n}function t(e,t){e.next?e.next(t):t instanceof Array?e.apply(n,t):e.call(n,t)}function r(e,t){var r=e.split(".")[0],s=n.on[r]=n.on[r]||[],o=s.length;if(!t)return n.on[e].source||(n.on[e].source=i());if(t.ns=e.split(".")[1])for(;~--o&&s[o].ns===t.ns;)s.splice(o,1);return s.push(t),t.next?t:n}function s(e,t){return(t=t||i()).once=!0,n.on(e,t)}function o(e,t){var r=n.on[e]||[],s=r.length;if(t&&t==r.source)return delete r.source;for(;~--s&&(t==r[s]||!t);)r.splice(s,1)}function i(){var n=promise();return n.listeners=[],n.i=0,n.map=function(e){var t=i();return n.listeners.push(function(n,r){t.next(e(n,r,t))}),n.listeners[n.listeners.length-1].fn=e,t},n.filter=function(e){var t=i();return n.listeners.push(function(n,r){e(n,r,t)&&t.next(n)}),n.listeners[n.listeners.length-1].fn=e,t},n.reduce=function(e,t){var r=i();return n.listeners.push(function(n,s){r.next(t=e(t,n,s,r))}),n.listeners[n.listeners.length-1].fn=e,r},n.next=function(e){return n.resolve(e),n.listeners.map(function(t){t(e,n.i)}),n.i++,n},n.off=function(e){for(var t=n.listeners.length;~--t&&(e==n.listeners[t].fn||!e);)n.listeners.splice(t,1);return n},n}return n=n||{},def(n,"emit",e,1),def(n,"once",s,1),def(n,"off",o,1),def(n,"on",r,1),n.on["*"]=[],n};